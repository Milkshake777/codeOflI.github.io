<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon128.ico?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon32.ico?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon16.ico?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">
  <link rel="alternate" href="/atom.xml" title="nicolas" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="spring boot高级[TOC]一.Spring Boot与缓存1、JSR107Java Caching定义了5个核心接口，分别是CachingProvider, CacheManager, Cache, Entry 和 Expiry。•CachingProvider定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可以在运行期访问多个CachingProvider。">
<meta name="keywords" content="java,spring,springBoot">
<meta property="og:type" content="article">
<meta property="og:title" content="springBoot高级">
<meta property="og:url" content="https://codeofli.github.io/2019/10/java-note/SpringBootHigh/springBoot-high/index.html">
<meta property="og:site_name" content="nicolas">
<meta property="og:description" content="spring boot高级[TOC]一.Spring Boot与缓存1、JSR107Java Caching定义了5个核心接口，分别是CachingProvider, CacheManager, Cache, Entry 和 Expiry。•CachingProvider定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可以在运行期访问多个CachingProvider。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://localhost:4000/2019/10/java-note/SpringBootHigh/springBoot-high/.%5CspringBoot-high%5C1569337676687.png">
<meta property="og:image" content="https://localhost:4000/2019/10/java-note/SpringBootHigh/springBoot-high/.%5CspringBoot-high%5C1569337715201.png">
<meta property="og:updated_time" content="2021-10-23T02:19:02.860Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="springBoot高级">
<meta name="twitter:description" content="spring boot高级[TOC]一.Spring Boot与缓存1、JSR107Java Caching定义了5个核心接口，分别是CachingProvider, CacheManager, Cache, Entry 和 Expiry。•CachingProvider定义了创建、配置、获取、管理和控制多个CacheManager。一个应用可以在运行期访问多个CachingProvider。">
<meta name="twitter:image" content="https://localhost:4000/2019/10/java-note/SpringBootHigh/springBoot-high/.%5CspringBoot-high%5C1569337676687.png">
  <link rel="canonical" href="https://codeofli.github.io/2019/10/java-note/SpringBootHigh/springBoot-high/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>springBoot高级 | nicolas</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">nicolas</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Yesterday you said tomorow.</p>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    
      
      
        
      
        
      
        
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
      
        
      
        
      
        
          
        
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">32</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
      
        
      
        
          
        
      
        
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">11</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
      
        
          
        
      
        
      
        
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">48</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/codeOflI/codeOflI.github.io/tree/dev" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://codeofli.github.io/2019/10/java-note/SpringBootHigh/springBoot-high/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nicolas lee">
      <meta itemprop="description" content="Yesterday you said tomorow.">
      <meta itemprop="image" content="/assets/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nicolas">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">springBoot高级

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-09 15:43:44" itemprop="dateCreated datePublished" datetime="2019-10-09T15:43:44+08:00">2019-10-09</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-23 10:19:02" itemprop="dateModified" datetime="2021-10-23T10:19:02+08:00">2021-10-23</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
          
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span></span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>spring boot高级</strong></p><p>[TOC]</p><h1 id="一-Spring-Boot与缓存"><a href="#一-Spring-Boot与缓存" class="headerlink" title="一.Spring Boot与缓存"></a>一.Spring Boot与缓存</h1><h2 id="1、JSR107"><a href="#1、JSR107" class="headerlink" title="1、JSR107"></a>1、JSR107</h2><p>Java Caching定义了5个核心接口，分别是<strong>CachingProvider</strong>, <strong>CacheManager</strong>, <strong>Cache</strong>, <strong>Entry</strong> 和 <strong>Expiry</strong>。</p><p>•<strong>CachingProvider</strong>定义了创建、配置、获取、管理和控制多个<strong>CacheManager</strong>。一个应用可以在运行期访问多个CachingProvider。</p><a id="more"></a>



<p>•<strong>CacheManager</strong>定义了创建、配置、获取、管理和控制多个唯一命名的<strong>Cache</strong>，这些Cache存在于CacheManager的上下文中。一个CacheManager仅被一个CachingProvider所拥有。</p>
<p>•<strong>Cache</strong>是一个类似Map的数据结构并临时存储以Key为索引的值。一个Cache仅被一个CacheManager所拥有。</p>
<p>•<strong>Entry</strong>是一个存储在Cache中的key-value对。</p>
<p>•<strong>Expiry</strong> 每一个存储在Cache中的条目有一个定义的有效期。一旦超过这个时间，条目为过期的状态。一旦过期，条目将不可访问、更新和删除。缓存有效期可以通过ExpiryPolicy设置。</p>
<table>
<thead>
<tr>
<th><strong>Cache</strong></th>
<th><strong>缓存接口，定义缓存操作。实现有：RedisCache、EhCacheCache、ConcurrentMapCache等</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>CacheManager</strong></td>
<td><strong>缓存管理器，管理各种缓存（**</strong>Cache<strong>**）组件</strong></td>
</tr>
<tr>
<td><strong>@Cacheable</strong></td>
<td><strong>主要针对方法配置，能够根据方法的请求参数对其结果进行缓存</strong></td>
</tr>
<tr>
<td><strong>@**</strong>CacheEvict**</td>
<td><strong>清空缓存</strong></td>
</tr>
<tr>
<td><strong>@CachePut</strong></td>
<td><strong>保证方法被调用，又希望结果被缓存。</strong></td>
</tr>
<tr>
<td><strong>@EnableCaching</strong></td>
<td><strong>开启基于注解的缓存</strong></td>
</tr>
<tr>
<td><strong>keyGenerator</strong></td>
<td><strong>缓存数据时key生成策略</strong></td>
</tr>
<tr>
<td><strong>serialize</strong></td>
<td><strong>缓存数据时value序列化策略</strong></td>
</tr>
</tbody></table>
<ul>
<li>一、搭建基本环境</li>
<li>1、导入数据库文件 创建出department和employee表</li>
<li>2、创建javaBean封装数据</li>
<li>3、整合MyBatis操作数据库</li>
<li>1.配置数据源信息</li>
<li>2.使用注解版的MyBatis；</li>
<li>1）、@MapperScan指定需要扫描的mapper接口所在的包</li>
</ul>
<h2 id="2、快速体验缓存"><a href="#2、快速体验缓存" class="headerlink" title="2、快速体验缓存"></a>2、快速体验缓存</h2><p><strong>==注意：cache注解（CachePut、Cacheable、@CachePut）的key保持一致，这样才能在cachemap中拿到同一个数据==</strong></p>
<h3 id="CacheConfig注解"><a href="#CacheConfig注解" class="headerlink" title="@CacheConfig注解"></a>@CacheConfig注解</h3><p><strong>抽取缓存的公共配置</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig</span>(cacheNames=<span class="string">"emp"</span>,cacheManager = <span class="string">"employeeCacheManager"</span>) <span class="comment">//抽取缓存的公共配置</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeService</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<h3 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h3><ul>
<li><p>==<strong>1、开启基于注解的缓存 @EnableCaching</strong>==</p>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@MapperScan</span>(value = <span class="string">"com.yoj.web.dao"</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YojApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(YojApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
<li><p>2、标注缓存注解即可</p>
</li>
<li><p>@Cacheable</p>
</li>
<li><p>@CacheEvict</p>
</li>
<li><p>@CachePut</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 默认使用的是ConcurrentMapCacheManager==ConcurrentMapCache；将数据保存在	ConcurrentMap&lt;Object, Object&gt;中</span></span><br><span class="line"><span class="comment"> * 开发中使用缓存中间件；redis、memcached、ehcache；</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>service层使用cache注解</p>
</li>
<li><p>缓存中能使用的spel表达式</p>
</li>
<li><p><strong>Cache*</strong> <strong><em>SpEL</em></strong> <strong><em>available metadata</em></strong></p>
</li>
</ul>
<table>
<thead>
<tr>
<th><strong>名字</strong></th>
<th><strong>位置</strong></th>
<th><strong>描述</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td>methodName</td>
<td>root object</td>
<td>当前被调用的方法名</td>
<td>#root.methodName</td>
</tr>
<tr>
<td>method</td>
<td>root object</td>
<td>当前被调用的方法</td>
<td>#root.method.name</td>
</tr>
<tr>
<td>target</td>
<td>root object</td>
<td>当前被调用的目标对象</td>
<td>#root.target</td>
</tr>
<tr>
<td>targetClass</td>
<td>root object</td>
<td>当前被调用的目标对象类</td>
<td>#root.targetClass</td>
</tr>
<tr>
<td>args</td>
<td>root object</td>
<td>当前被调用的方法的参数列表</td>
<td>#root.args[0]</td>
</tr>
<tr>
<td>caches</td>
<td>root object</td>
<td>当前方法调用使用的缓存列表（如@Cacheable(value={“cache1”,   “cache2”})），则有两个cache</td>
<td>#root.caches[0].name</td>
</tr>
<tr>
<td><em>argument name</em></td>
<td>evaluation context</td>
<td>方法参数的名字. 可以直接 #参数名 ，也可以使用 #p0或#a0 的形式，0代表参数的索引；</td>
<td>#iban 、 #a0 、  #p0</td>
</tr>
<tr>
<td>result</td>
<td>evaluation context</td>
<td>方法执行后的返回值（仅当方法执行之后的判断有效，如‘unless’，’cache put’的表达式 ’cache evict’的表达式beforeInvocation=false）</td>
<td>#result</td>
</tr>
</tbody></table>
<h3 id="Cacheable注解"><a href="#Cacheable注解" class="headerlink" title="@Cacheable注解"></a>@Cacheable注解</h3><h4 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h4><ul>
<li><p>1、自动配置类；CacheAutoConfiguration</p>
</li>
<li><p>2、缓存的配置类(11)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.cache.GenericCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.JCacheCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.EhCacheCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.HazelcastCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.InfinispanCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CouchbaseCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CaffeineCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.GuavaCacheConfiguration</span><br><span class="line">org.springframework.boot.autoconfigure.cache.SimpleCacheConfiguration【默认】</span><br><span class="line">org.springframework.boot.autoconfigure.cache.NoOpCacheConfiguration</span><br></pre></td></tr></table></figure>

<ul>
<li>3、哪个配置类默认生效：SimpleCacheConfiguration；</li>
</ul>
</li>
<li><p>4、给容器中注册了一个CacheManager：ConcurrentMapCacheManager</p>
</li>
<li><ul>
<li>5、可以获取和创建ConcurrentMapCache类型的缓存组件；他的作用将数据保存在ConcurrentMap中；</li>
</ul>
</li>
</ul>
<h4 id="运行流程：-ConcurrentMapCacheManager-class"><a href="#运行流程：-ConcurrentMapCacheManager-class" class="headerlink" title="运行流程：(ConcurrentMapCacheManager.class)"></a>运行流程：(ConcurrentMapCacheManager.class)</h4><p>   @Cacheable：<br>   1、方法运行之前，先去<strong>查询Cache（缓存组件）</strong>，按照cacheNames指定的名字获取；<br>   （CacheManager先获取相应的缓存），第一次获取缓存如果没有Cache组件会自动创建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    Cache cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.dynamic) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.cacheMap) &#123;</span><br><span class="line">            cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">            <span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cache = createConcurrentMapCache(name);</span><br><span class="line">                <span class="keyword">this</span>.cacheMap.put(name, cache);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   2、去Cache中查找缓存的内容，使用一个key，默认就是方法的参数；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">lookup</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.store.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   key是按照某种策略生成的；默认是使用keyGenerator生成的，默认使用SimpleKeyGenerator生成key；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheAspectSupport</span> <span class="keyword">extends</span> <span class="title">AbstractCacheInvoker</span></span></span><br><span class="line"><span class="class"><span class="title">protected</span> <span class="title">Object</span> <span class="title">generateKey</span>(@<span class="title">Nullable</span> <span class="title">Object</span> <span class="title">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.metadata.operation.getKey())) &#123;</span><br><span class="line">        EvaluationContext evaluationContext = createEvaluationContext(result);</span><br><span class="line">        <span class="keyword">return</span> evaluator.key(<span class="keyword">this</span>.metadata.operation.getKey(), <span class="keyword">this</span>.metadata.methodKey, evaluationContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.metadata.keyGenerator.generate(<span class="keyword">this</span>.target, <span class="keyword">this</span>.metadata.method, <span class="keyword">this</span>.args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   SimpleKeyGenerator生成key的默认策略；<br>   如果没有参数；key=new SimpleKey()；<br>   如果有一个参数：key=参数的值<br>   如果有多个参数：key=new SimpleKey(params)；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleKeyGenerator</span> <span class="keyword">implements</span> <span class="title">KeyGenerator</span> </span>&#123;  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Generate a key based on the specified parameters.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">generateKey</span><span class="params">(Object... params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (params.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SimpleKey.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (params.length == <span class="number">1</span>) &#123;</span><br><span class="line">        Object param = params[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (param != <span class="keyword">null</span> &amp;&amp; !param.getClass().isArray()) &#123;</span><br><span class="line">            <span class="keyword">return</span> param;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimpleKey(params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   3、没有查到缓存就调用目标方法；<br>     4、将目标方法返回的结果，放进缓存中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, @Nullable Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.store.put(key, toStoreValue(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   @Cacheable标注的方法执行之前先来检查缓存中有没有这个数据，默认按照参数的值作为key去查询缓存，<br>     如果没有就运行方法并将结果放入缓存；以后再来调用就可以直接使用缓存中的数据；<br>   ==<strong>核心：</strong>==<br>   1）、使用CacheManager【ConcurrentMapCacheManager】按照名字得到Cache【ConcurrentMapCache】组件<br>     2）、key使用keyGenerator生成的，默认是SimpleKeyGenerator</p>
<h3 id="几个属性："><a href="#几个属性：" class="headerlink" title="几个属性："></a>几个属性：</h3><ul>
<li><p>cacheNames/value：指定缓存组件的名字;将方法的返回结果放在哪个缓存中，是数组的方式，可以指定多个缓存；</p>
</li>
<li><p>key：缓存数据使用的key；可以用它来指定。默认是使用方法参数的值  1-方法的返回值</p>
<pre><code>编写SpEL； #i d;参数id的值   #a0  #p0  #root.args[0]
     getEmp[2] ： **key = &quot;#root.methodName+&apos;[&apos;+#id+&apos;]&apos;&quot;**</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(cacheNames = &#123;<span class="string">"emp"</span>&#125;,key = <span class="string">"#root.methodName+'['+#id+']'"</span>)</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>keyGenerator：key的生成器；可以自己指定key的生成器的组件id</p>
<pre><code>key/keyGenerator：二选一使用;</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCacheConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"myKeyGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> 				</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> method.getName()+<span class="string">"["</span>+ Arrays.asList(params).toString()+<span class="string">"]"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"> <span class="meta">@Cacheable</span>(cacheNames = &#123;<span class="string">"emp"</span>&#125;,keyGenerator = <span class="string">"myKeyGenerator"</span>)</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>cacheManager：指定缓存管理器；或者cacheResolver指定获取解析器</p>
</li>
<li><p>condition：指定符合条件的情况下才缓存；</p>
<pre><code>,condition = &quot;#id&gt;0&quot;
 condition = &quot;#a0&gt;1&quot;：第一个参数的值 &gt;1的时候才进行缓存</code></pre></li>
<li><p><strong>unless==:否定缓存==；当unless指定的条件为true，方法的返回值就不会被缓存；</strong>可以获取到结果进行判断</p>
<pre><code>unless = &quot;#result == null&quot;
unless = &quot;#a0==2&quot;:如果第一个参数的值是2，结果不缓存；</code></pre></li>
<li><p>sync：是否使用异步模式,启用sync就不能使用unless属性了</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig</span>(cacheNames=<span class="string">"emp"</span><span class="comment">/*,cacheManager = "employeeCacheManager"*/</span>) <span class="comment">//抽取缓存的公共配置</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将方法的运行结果进行缓存；以后再要相同的数据，直接从缓存中获取，不用调用方法；</span></span><br><span class="line"><span class="comment">     * CacheManager管理多个Cache组件的，对缓存的真正CRUD操作在Cache组件中，每一个缓存组件有自己唯一一个名字；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     *   </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(value = &#123;<span class="string">"emp"</span>&#125;<span class="comment">/*,keyGenerator = "myKeyGenerator",condition = "#a0&gt;1",unless = "#a0==2"*/</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmp</span><span class="params">(Integer id)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"查询"</span>+id+<span class="string">"号员工"</span>);</span><br><span class="line">        Employee emp = employeeMapper.getEmpById(id);</span><br><span class="line">        <span class="keyword">return</span> emp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Caching 定义复杂的缓存规则</span></span><br><span class="line">    <span class="meta">@Caching</span>(</span><br><span class="line">         cacheable = &#123;</span><br><span class="line">             <span class="meta">@Cacheable</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#lastName"</span>)</span><br><span class="line">         &#125;,</span><br><span class="line">         put = &#123;</span><br><span class="line">             <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.id"</span>),</span><br><span class="line">             <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.email"</span>)</span><br><span class="line">         &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpByLastName</span><span class="params">(String lastName)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> employeeMapper.getEmpByLastName(lastName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CachePut注解"><a href="#CachePut注解" class="headerlink" title="@CachePut注解"></a>@CachePut注解</h3><p>@CachePut：既调用方法，又更新缓存数据；同步更新缓存<br>  修改了数据库的某个数据，同时更新缓存；<br>  <strong>运行时机：</strong><br>1、先调用目标方法<br>2、将目标方法的结果缓存起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试步骤：</span></span><br><span class="line"><span class="comment"> *  1、查询1号员工；查到的结果会放在缓存中；</span></span><br><span class="line"><span class="comment"> *          key：1  value：lastName：张三</span></span><br><span class="line"><span class="comment"> *  2、以后查询还是之前的结果</span></span><br><span class="line"><span class="comment"> *  3、更新1号员工；【lastName:zhangsan；gender:0】</span></span><br><span class="line"><span class="comment"> *          将方法的返回值也放进缓存了；</span></span><br><span class="line"><span class="comment"> *          key：传入的employee对象  值：返回的employee对象；</span></span><br><span class="line"><span class="comment"> *  4、查询1号员工？</span></span><br><span class="line"><span class="comment"> *      应该是更新后的员工；</span></span><br><span class="line"><span class="comment"> *          key = "#employee.id":使用传入的参数的员工id；</span></span><br><span class="line"><span class="comment"> *          key = "#result.id"：使用返回后的id</span></span><br><span class="line"><span class="comment"> *             <span class="doctag">@Cacheable</span>的key是不能用#result</span></span><br><span class="line"><span class="comment"> *      为什么是没更新前的？【1号员工没有在缓存中更新】</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CachePut</span>(<span class="comment">/*value = "emp",*/</span>key = <span class="string">"#result.id"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Employee <span class="title">updateEmp</span><span class="params">(Employee employee)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"updateEmp:"</span>+employee);</span><br><span class="line">    employeeMapper.updateEmp(employee);</span><br><span class="line">    <span class="keyword">return</span> employee;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CacheEvict注解"><a href="#CacheEvict注解" class="headerlink" title="@CacheEvict注解"></a>@CacheEvict注解</h3><p><strong>evict：驱逐，逐出</strong></p>
<p>@CacheEvict：缓存清除</p>
<ul>
<li>key：指定要清除的数据</li>
<li>-allEntries = true：指定清除这个缓存中所有的数据</li>
<li>beforeInvocation = false：缓存的清除是否在方法之前执行<br><strong>默认代表缓存清除操作是在方法执行之后执行;如果出现异常缓存就不会清除</strong></li>
<li>beforeInvocation = true：<br>代表清除缓存操作是在方法运行之前执行，无论方法是否出现异常，缓存都清除</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheEvict</span>(value=<span class="string">"emp"</span>,beforeInvocation = <span class="keyword">true</span><span class="comment">/*key = "#id",*/</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteEmp</span><span class="params">(Integer id)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"deleteEmp:"</span>+id);</span><br><span class="line">    <span class="comment">//employeeMapper.deleteEmpById(id);</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Caching注解"><a href="#Caching注解" class="headerlink" title="@Caching注解"></a>@Caching注解</h3><p>定义复杂的缓存规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Caching 定义复杂的缓存规则</span></span><br><span class="line"> <span class="meta">@Caching</span>(</span><br><span class="line">      cacheable = &#123;</span><br><span class="line">          <span class="meta">@Cacheable</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#lastName"</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      put = &#123;</span><br><span class="line">          <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.id"</span>),</span><br><span class="line">          <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.email"</span>)</span><br><span class="line">      &#125;</span><br><span class="line"> )</span><br><span class="line"> <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpByLastName</span><span class="params">(String lastName)</span></span>&#123;</span><br><span class="line">     <span class="keyword">return</span> employeeMapper.getEmpByLastName(lastName);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springboot01cache.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.springboot01cache.bean.Employee;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.springboot01cache.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CacheConfig</span>(cacheNames = <span class="string">"emp"</span><span class="comment">/*,cacheManager = "employeeCacheManager"*/</span>) <span class="comment">//抽取缓存的公共配置</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将方法的运行结果进行缓存；以后再要相同的数据，直接从缓存中获取，不用调用方法；</span></span><br><span class="line"><span class="comment">     * CacheManager管理多个Cache组件的，对缓存的真正CRUD操作在Cache组件中，每一个缓存组件有自己唯一一个名字；</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 原理：</span></span><br><span class="line"><span class="comment">     * 1、自动配置类；CacheAutoConfiguration</span></span><br><span class="line"><span class="comment">     * 2、缓存的配置类</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.GenericCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.JCacheCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.EhCacheCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.HazelcastCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.InfinispanCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.CouchbaseCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.CaffeineCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.GuavaCacheConfiguration</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.SimpleCacheConfiguration【默认】</span></span><br><span class="line"><span class="comment">     * org.springframework.boot.autoconfigure.cache.NoOpCacheConfiguration</span></span><br><span class="line"><span class="comment">     * 3、哪个配置类默认生效：SimpleCacheConfiguration；</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 4、给容器中注册了一个CacheManager：ConcurrentMapCacheManager</span></span><br><span class="line"><span class="comment">     * 5、可以获取和创建ConcurrentMapCache类型的缓存组件；他的作用将数据保存在ConcurrentMap中；</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 运行流程：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Cacheable</span>： 1、方法运行之前，先去查询Cache（缓存组件），按照cacheNames指定的名字获取；</span></span><br><span class="line"><span class="comment">     * （CacheManager先获取相应的缓存），第一次获取缓存如果没有Cache组件会自动创建。</span></span><br><span class="line"><span class="comment">     * 2、去Cache中查找缓存的内容，使用一个key，默认就是方法的参数；</span></span><br><span class="line"><span class="comment">     * key是按照某种策略生成的；默认是使用keyGenerator生成的，默认使用SimpleKeyGenerator生成key；</span></span><br><span class="line"><span class="comment">     * SimpleKeyGenerator生成key的默认策略；</span></span><br><span class="line"><span class="comment">     * 如果没有参数；key=new SimpleKey()；</span></span><br><span class="line"><span class="comment">     * 如果有一个参数：key=参数的值</span></span><br><span class="line"><span class="comment">     * 如果有多个参数：key=new SimpleKey(params)；</span></span><br><span class="line"><span class="comment">     * 3、没有查到缓存就调用目标方法；</span></span><br><span class="line"><span class="comment">     * 4、将目标方法返回的结果，放进缓存中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Cacheable</span>标注的方法执行之前先来检查缓存中有没有这个数据，默认按照参数的值作为key去查询缓存， 如果没有就运行方法并将结果放入缓存；以后再来调用就可以直接使用缓存中的数据；</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 核心：</span></span><br><span class="line"><span class="comment">     * 1）、使用CacheManager【ConcurrentMapCacheManager】按照名字得到Cache【ConcurrentMapCache】组件</span></span><br><span class="line"><span class="comment">     * 2）、key使用keyGenerator生成的，默认是SimpleKeyGenerator</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 几个属性：</span></span><br><span class="line"><span class="comment">     * cacheNames/value：指定缓存组件的名字;将方法的返回结果放在哪个缓存中，是数组的方式，可以指定多个缓存；</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * key：缓存数据使用的key；可以用它来指定。默认是使用方法参数的值  1-方法的返回值</span></span><br><span class="line"><span class="comment">     * 编写SpEL； #i d;参数id的值   #a0  #p0  #root.args[0]</span></span><br><span class="line"><span class="comment">     * getEmp[2]</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * keyGenerator：key的生成器；可以自己指定key的生成器的组件id</span></span><br><span class="line"><span class="comment">     * key/keyGenerator：二选一使用;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * cacheManager：指定缓存管理器；或者cacheResolver指定获取解析器</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * condition：指定符合条件的情况下才缓存；</span></span><br><span class="line"><span class="comment">     * ,condition = "#id&gt;0"</span></span><br><span class="line"><span class="comment">     * condition = "#a0&gt;1"：第一个参数的值》1的时候才进行缓存</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * sync：是否使用异步模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(value = &#123;<span class="string">"emp"</span>&#125;<span class="comment">/*,keyGenerator = "myKeyGenerator",condition = "#a0&gt;1",unless = "#a0==2"*/</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmp</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"查询"</span> + id + <span class="string">"号员工"</span>);</span><br><span class="line">        Employee emp = employeeMapper.getEmpById(id);</span><br><span class="line">        <span class="keyword">return</span> emp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CachePut</span>：既调用方法，又更新缓存数据；同步更新缓存 修改了数据库的某个数据，同时更新缓存；</span></span><br><span class="line"><span class="comment">     * 运行时机：</span></span><br><span class="line"><span class="comment">     * 1、先调用目标方法</span></span><br><span class="line"><span class="comment">     * 2、将目标方法的结果缓存起来</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 测试步骤：</span></span><br><span class="line"><span class="comment">     * 1、查询1号员工；查到的结果会放在缓存中；</span></span><br><span class="line"><span class="comment">     * key：1  value：lastName：张三</span></span><br><span class="line"><span class="comment">     * 2、以后查询还是之前的结果</span></span><br><span class="line"><span class="comment">     * 3、更新1号员工；【lastName:zhangsan；gender:0】</span></span><br><span class="line"><span class="comment">     * 将方法的返回值也放进缓存了；</span></span><br><span class="line"><span class="comment">     * key：传入的employee对象  值：返回的employee对象；</span></span><br><span class="line"><span class="comment">     * 4、查询1号员工？</span></span><br><span class="line"><span class="comment">     * 应该是更新后的员工；</span></span><br><span class="line"><span class="comment">     * key = "#employee.id":使用传入的参数的员工id；</span></span><br><span class="line"><span class="comment">     * key = "#result.id"：使用返回后的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Cacheable</span>的key是不能用#result 为什么是没更新前的？【1号员工没有在缓存中更新】</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CachePut</span>(value = <span class="string">"emp"</span>, key = <span class="string">"#result.id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">updateEmp</span><span class="params">(Employee employee)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"updateEmp:"</span> + employee);</span><br><span class="line">        employeeMapper.updateEmp(employee);</span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CacheEvict</span>：缓存清除 key：指定要清除的数据</span></span><br><span class="line"><span class="comment">     * allEntries = true：指定清除这个缓存中所有的数据</span></span><br><span class="line"><span class="comment">     * beforeInvocation = false：缓存的清除是否在方法之前执行</span></span><br><span class="line"><span class="comment">     * 默认代表缓存清除操作是在方法执行之后执行;如果出现异常缓存就不会清除</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * beforeInvocation = true：</span></span><br><span class="line"><span class="comment">     * 代表清除缓存操作是在方法运行之前执行，无论方法是否出现异常，缓存都清除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CacheEvict</span>(value = <span class="string">"emp"</span>, beforeInvocation = <span class="keyword">true</span><span class="comment">/*key = "#id",*/</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteEmp</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"deleteEmp:"</span> + id);</span><br><span class="line">        <span class="comment">//employeeMapper.deleteEmpById(id);</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Caching 定义复杂的缓存规则</span></span><br><span class="line">    <span class="meta">@Caching</span>(</span><br><span class="line">            cacheable = &#123;</span><br><span class="line">                    <span class="meta">@Cacheable</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#lastName"</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            put = &#123;</span><br><span class="line">                    <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.id"</span>),</span><br><span class="line">                    <span class="meta">@CachePut</span>(<span class="comment">/*value="emp",*/</span>key = <span class="string">"#result.email"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpByLastName</span><span class="params">(String lastName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> employeeMapper.getEmpByLastName(lastName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-整合redis作为缓存"><a href="#3-整合redis作为缓存" class="headerlink" title="3.整合redis作为缓存"></a>3.整合redis作为缓存</h2><p> Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。</p>
<p> 原理：CacheManager===Cache 缓存组件来实际给缓存中存取数据<br> 1）、引入redis的starter，容器中保存的是 RedisCacheManager；<br> 2）、RedisCacheManager 帮我们创建 RedisCache 来作为缓存组件；RedisCache通过操作redis缓存数据的<br> 3）、默认保存数据 kv 都是Object；利用序列化保存；如何保存为json<br> 1、引入了redis的starter，cacheManager变为 RedisCacheManager；<br> 2、默认创建的 RedisCacheManager 操作redis的时候使用的是 RedisTemplate&lt;Object, Object&gt;<br> 3、RedisTemplate&lt;Object, Object&gt; 是 默认使用jdk的序列化机制<br> 4）、自定义CacheManager；</p>
<h3 id="1、安装redis：使用docker；"><a href="#1、安装redis：使用docker；" class="headerlink" title="1、安装redis：使用docker；"></a>1、安装redis：使用docker；</h3><p><strong>启动redis，默认端口6379</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R3A-srv ~]# docker run -d -p 6379:6379 --name myredis redis</span><br><span class="line">ba86c7f5d285b74828df3ec4f0179cfcd3682dc58f2cfabe354a63336d94919e</span><br><span class="line"><span class="meta">#</span><span class="bash">开启持久化</span></span><br><span class="line">docker run  -d -p 6379:6379 --name persistent-redis redis --appendonly yes</span><br><span class="line"></span><br><span class="line">docker run --name="redis-2" -d -p 6378:6379 -v /home/fr/redis:/opt royfans/redis:v1 /usr/local/redis/bin/redis-server /usr/local/redis/redis.conf --appendonly yes</span><br></pre></td></tr></table></figure>

<p>==<strong>注意</strong>==：<strong>如果不开启持久化，会导致一段时间不用缓存之后，连接不上redis</strong></p>
<p><strong>start with persistent storage</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /myredis/conf/redis.conf:/home/ubuntu/redis/redis.conf -d -p 6379:6379 --name config-redis redis --appendonly yes</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run --name some-redis -d redis redis-server --appendonly yes</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -v /myredis/conf/redis.conf:/usr/<span class="built_in">local</span>/etc/redis/redis.conf --name myredis redis redis-server /usr/<span class="built_in">local</span>/etc/redis/redis.conf</span></span><br></pre></td></tr></table></figure>

<p>Where /myredis/conf/ is a local directory containing your redis.conf file. Using this method means that there is no need for you to have a Dockerfile for your redis container.</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">这个问题我们在项目中遇到同样的问题，目前已经解决了。最终得到的答案是： 服务器不稳定造成的。</span><br><span class="line">您可以尝试这样解决：</span><br><span class="line"><span class="number">1.</span>推荐使用生产环境的服务器，并且将redis 绑定生产环境的ip;因为云服务器的ip 地址是很稳定的，而本地服务的ip地址经常是变动的；经 </span><br><span class="line">   过测试，这种每过<span class="number">10</span>分就会重新请求连接，还会发生重试失败的情况，就是因为服务器不稳定造成的；</span><br><span class="line"><span class="number">2.</span>如果你在生产环境中，使用docker 部署，建议 不要在docker容器中 安装redis; 因为docker 容器 默认分配的ip 地址，也可能是变化的；</span><br><span class="line">  您可以直接将redis 安装在 服务器目录下，即可；</span><br></pre></td></tr></table></figure>

<p>redis desktop manager连接</p>
<p>![1565350310934](redis desktop manager连接.png)</p>
<h3 id="2、引入redis的starter"><a href="#2、引入redis的starter" class="headerlink" title="2、引入redis的starter"></a>2、引入redis的starter</h3><p>1.引入spring-boot-starter-data-redis</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3、配置redis"><a href="#3、配置redis" class="headerlink" title="3、配置redis"></a>3、配置redis</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定主机端口号</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">192.168.31.39</span></span><br></pre></td></tr></table></figure>

<h3 id="4、测试缓存"><a href="#4、测试缓存" class="headerlink" title="4、测试缓存"></a>4、测试缓存</h3><p>3.使用RestTemplate操作redis</p>
<p>1.redisTemplate.opsForValue();//操作字符串</p>
<p>2.redisTemplate.opsForHash();//操作hash</p>
<p>3.redisTemplate.opsForList();//操作list</p>
<p>4.redisTemplate.opsForSet();//操作set</p>
<p>5.redisTemplate.opsForZSet();//操作有序set</p>
<p>4.配置缓存、CacheManagerCustomizers</p>
<p>5.测试使用缓存、切换缓存、 CompositeCacheManager</p>
<p><strong>==stringRedisTemplate==</strong></p>
<p>//操作k-v都是字符串的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">StringRedisTemplate stringRedisTemplate;  <span class="comment">//操作k-v都是字符串的</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Redis常见的五大数据类型</span></span><br><span class="line"><span class="comment">     *  String（字符串）、List（列表）、Set（集合）、Hash（散列）、ZSet（有序集合）</span></span><br><span class="line"><span class="comment">     *  stringRedisTemplate.opsForValue()[String（字符串）]</span></span><br><span class="line"><span class="comment">     *  stringRedisTemplate.opsForList()[List（列表）]</span></span><br><span class="line"><span class="comment">     *  stringRedisTemplate.opsForSet()[Set（集合）]</span></span><br><span class="line"><span class="comment">     *  stringRedisTemplate.opsForHash()[Hash（散列）]</span></span><br><span class="line"><span class="comment">     *  stringRedisTemplate.opsForZSet()[ZSet（有序集合）]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//给redis中保存数据</span></span><br><span class="line">    <span class="comment">//stringRedisTemplate.opsForValue().append("msg","hello");</span></span><br><span class="line">    <span class="comment">//获取数据</span></span><br><span class="line">    <span class="comment">//		String msg = stringRedisTemplate.opsForValue().get("msg");</span></span><br><span class="line">    <span class="comment">//		System.out.println(msg);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存list集合数据</span></span><br><span class="line">    stringRedisTemplate.opsForList().leftPush(<span class="string">"mylist"</span>,<span class="string">"1"</span>);</span><br><span class="line">    stringRedisTemplate.opsForList().leftPush(<span class="string">"mylist"</span>,<span class="string">"2"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>==redisTemplate==</strong></p>
<p>k-v都是对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate redisTemplate; <span class="comment">//k-v都是对象的</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate&lt;Object,Object&gt; empRedisTemplate; <span class="comment">//自定义缓存规则配置的redisTemplate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//测试保存对象</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Employee empById = employeeMapper.getEmpById(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//默认如果保存对象，使用jdk序列化机制，序列化后的数据保存到redis中</span></span><br><span class="line">        <span class="comment">//redisTemplate.opsForValue().set("emp-01",empById);</span></span><br><span class="line">        <span class="comment">//1、将数据以json的方式保存</span></span><br><span class="line">        <span class="comment">//(1)自己将对象转为json</span></span><br><span class="line">        <span class="comment">//(2)redisTemplate默认的序列化规则；改变默认的序列化规则；</span></span><br><span class="line">        empRedisTemplate.opsForValue().set(<span class="string">"emp-01"</span>,empById);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-使用Json格式序列化对象"><a href="#5-使用Json格式序列化对象" class="headerlink" title="5.使用Json格式序列化对象"></a>5.使用Json格式序列化对象</h3><p>1.使用setKey和value的Serializer方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.setValueSerializer(<span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Employee&gt;(Employee.class));</span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Employee&gt;(Employee.class));</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">"emp-02"</span>,empById);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">empRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Employee&gt; serializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Employee&gt;(Employee.class);</span><br><span class="line">        template.setDefaultSerializer(serializer);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-0配置redis的CacheManager"><a href="#2-0配置redis的CacheManager" class="headerlink" title="2.0配置redis的CacheManager"></a>2.0配置redis的CacheManager</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    redis:</span></span><br><span class="line"><span class="attr">      timeToLive:</span> <span class="number">1000000</span> <span class="comment">#毫秒</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.springboot01cache.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public RedisTemplate&lt;Object, Object&gt; empRedisTemplate(RedisConnectionFactory redisConnectionFactory)</span></span><br><span class="line"><span class="comment">//            throws UnknownHostException &#123;</span></span><br><span class="line"><span class="comment">//        RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        template.setConnectionFactory(redisConnectionFactory);</span></span><br><span class="line"><span class="comment">//        Jackson2JsonRedisSerializer&lt;Employee&gt; serializer = new Jackson2JsonRedisSerializer&lt;Employee&gt;(Employee.class);</span></span><br><span class="line"><span class="comment">//        template.setDefaultSerializer(serializer);</span></span><br><span class="line"><span class="comment">//        return template;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Duration timeToLive = Duration.ZERO;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeToLive</span><span class="params">(Duration timeToLive)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timeToLive = timeToLive;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解决查询缓存转换异常的问题</span></span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置序列化（解决乱码的问题）</span></span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .entryTtl(timeToLive)</span><br><span class="line">                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))</span><br><span class="line">                .disableCachingNullValues();</span><br><span class="line"></span><br><span class="line">        RedisCacheManager cacheManager = RedisCacheManager.builder(factory)</span><br><span class="line">                .cacheDefaults(config)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-注意"><a href="#4-注意" class="headerlink" title="4.注意"></a>4.注意</h2><h2 id="1-CachePut-获取就是返回的值"><a href="#1-CachePut-获取就是返回的值" class="headerlink" title="1.@CachePut 获取就是返回的值"></a>1.@CachePut 获取就是返回的值</h2><p>所有想要存入缓存的都是返回的值</p>
<h2 id="my-redis"><a href="#my-redis" class="headerlink" title="my_redis"></a>my_redis</h2><h3 id="设置缓存时间"><a href="#设置缓存时间" class="headerlink" title="设置缓存时间"></a>设置缓存时间</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.opsForValue().set(email, checkCode,<span class="number">60</span>*<span class="number">10</span>,TimeUnit.SECONDS);<span class="comment">//向redis里存入数据和设置缓存时间</span></span><br></pre></td></tr></table></figure>

<h3 id="删除缓存byKey"><a href="#删除缓存byKey" class="headerlink" title="删除缓存byKey"></a>删除缓存byKey</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.delete(user.getEmail());</span><br></pre></td></tr></table></figure>

<h3 id="检查时间"><a href="#检查时间" class="headerlink" title="检查时间"></a>检查时间</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.hasKey(<span class="string">"546545"</span>);<span class="comment">//检查key是否存在，返回boolean值</span></span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="redis一段时间之后不连接就连不上"><a href="#redis一段时间之后不连接就连不上" class="headerlink" title="redis一段时间之后不连接就连不上"></a>redis一段时间之后不连接就连不上</h3><p><strong>==内存原因，设置maxmemory和替换算法==</strong></p>
<p>  在Linux上，如果开了redis的守护进程，kill -9和redis-cli shutdown 命令是无法杀掉 redis 进程的 ，杀掉就会重新启动一个新的进程</p>
<p>最后在网上找到这个命令：</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/redis-<span class="built_in">server</span> <span class="keyword">stop</span></span><br></pre></td></tr></table></figure>

<h1 id="二-Spring-Boot与消息"><a href="#二-Spring-Boot与消息" class="headerlink" title="二.Spring Boot与消息"></a>二.Spring Boot与消息</h1><p>JMS、AMQP、RabbitMQ</p>
<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>1.大多应用中，可通过消息服务中间件来提升系统异步通信、扩展解耦能力</p>
<p>2.消息服务中两个重要概念：</p>
<p>​       <strong>消息代理（message broker）和目的地（destination）</strong></p>
<p>当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地。</p>
<p>3.消息队列主要有两种形式的目的地</p>
<p> 1.队列（queue）：点对点消息通信（point-to-point）</p>
<p> 2.主题（topic）：发布（publish）/订阅（subscribe）消息通信</p>
<p>4.点对点式：</p>
<p>–消息发送者发送消息，消息代理将其放入一个队列中，消息接收者从队列中获取消息内容，消息读取后被移出队列</p>
<p>–消息只有唯一的发送者和接受者，但并不是说只能有一个接收者</p>
<p>5.发布订阅式：</p>
<p>–发送者（发布者）发送消息到主题，多个接收者（订阅者）监听（订阅）这个主题，那么就会在消息到达时同时收到消息</p>
<p>6.JMS（Java Message Service）JAVA消息服务：</p>
<p>–基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现</p>
<p>7.AMQP（Advanced Message Queuing Protocol）</p>
<p>–高级消息队列协议，也是一个消息代理的规范，兼容JMS</p>
<p>–RabbitMQ是AMQP的实现</p>
<table>
<thead>
<tr>
<th></th>
<th>JMS</th>
<th>AMQP</th>
</tr>
</thead>
<tbody><tr>
<td>定义</td>
<td>Java   api</td>
<td>网络线级协议</td>
</tr>
<tr>
<td>跨语言</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>跨平台</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>Model</td>
<td>提供两种消息模型：   （1）、Peer-2-Peer   （2）、Pub/sub</td>
<td>提供了五种消息模型：   （1）、direct   exchange   （2）、fanout   exchange   （3）、topic   change   （4）、headers   exchange   （5）、system   exchange   本质来讲，后四种和JMS的pub/sub模型没有太大差别，仅是在路由机制上做了更详细的划分；</td>
</tr>
<tr>
<td>支持消息类型</td>
<td>多种消息类型：   TextMessage   MapMessage   BytesMessage   StreamMessage   ObjectMessage   Message   （只有消息头和属性）</td>
<td>byte[]   当实际应用时，有复杂的消息，可以将消息序列化后发送。</td>
</tr>
<tr>
<td>综合评价</td>
<td>JMS   定义了JAVA   API层面的标准；在java体系中，多个client均可以通过JMS进行交互，不需要应用修改代码，但是其对跨平台的支持较差；</td>
<td>AMQP定义了wire-level层的协议标准；天然具有跨平台、跨语言特性。</td>
</tr>
</tbody></table>
<p>8.Spring支持</p>
<p><strong>–spring-jms提供了对JMS的支持</strong></p>
<p><strong>–spring-rabbit提供了对AMQP的支持</strong></p>
<p><strong>–需要ConnectionFactory的实现来连接消息代理</strong></p>
<p><strong>–提供JmsTemplate、RabbitTemplate来发送消息</strong></p>
<p><strong>–@JmsListener（JMS）、@RabbitListener（AMQP）注解在方法上监听消息代理发布的消息</strong></p>
<p><strong>–@EnableJms、@EnableRabbit开启支持</strong></p>
<p>9.Spring Boot自动配置</p>
<p>–<strong>JmsAutoConfiguration</strong></p>
<p>–<strong>RabbitAutoConfiguration</strong></p>
<h2 id="二、RabbitMQ简介"><a href="#二、RabbitMQ简介" class="headerlink" title="二、RabbitMQ简介"></a>二、RabbitMQ简介</h2><p><strong>RabbitMQ简介：</strong></p>
<p>RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue Protocol)的开源实现。</p>
<p><strong>核心概念</strong></p>
<p><strong>Message</strong></p>
<p>消息，消息是不具名的，它由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性存储）等。</p>
<p><strong>Publisher</strong></p>
<p>消息的生产者，也是一个向交换器发布消息的客户端应用程序。</p>
<p><strong>Exchange</strong></p>
<p>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。</p>
<p>Exchange有4种类型：direct(默认)，fanout, topic, 和headers，不同类型的Exchange转发消息的策略有所区别</p>
<p>三、Spring Boot与检索</p>
<h1 id="四-Spring-Boot与任务"><a href="#四-Spring-Boot与任务" class="headerlink" title="四.Spring Boot与任务"></a>四.Spring Boot与任务</h1><h2 id="异步任务、定时任务、邮件任务"><a href="#异步任务、定时任务、邮件任务" class="headerlink" title="异步任务、定时任务、邮件任务"></a>异步任务、定时任务、邮件任务</h2><h2 id="一、异步任务"><a href="#一、异步任务" class="headerlink" title="一、异步任务"></a>一、异步任务</h2><p>在Java应用中，绝大多数情况下都是通过同步的方式来实现交互处理的；但是在处理与第三方系统交互的时候，容易造成响应迟缓的情况，之前大部分都是使用多线程来完成此类任务，其实，在Spring 3.x之后，就已经内置了@Async来完美解决这个问题。</p>
<p><strong>两个注解：</strong></p>
<p>@EnableAysnc、@Aysnc</p>
<p><strong>springbootApplication添加@EnableAysnc注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span>  <span class="comment">//开启异步注解功能</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Springboot04TaskApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Springboot04TaskApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写异步方法，同时执行</strong>，并不会等3s才有success</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//告诉Spring这是一个异步方法</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"处理数据中..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、定时任务"><a href="#二、定时任务" class="headerlink" title="二、定时任务"></a>二、定时任务</h2><p>@EnableScheduling //开启基于注解的定时任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableScheduling</span> <span class="comment">//开启基于注解的定时任务</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Springboot04TaskApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Springboot04TaskApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写定时方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * second(秒), minute（分）, hour（时）, day of month（日）, month（月）, day of week（周几）.</span></span><br><span class="line"><span class="comment">     * 0 * * * * MON-FRI</span></span><br><span class="line"><span class="comment">     *  【0 0/5 14,18 * * ?】 每天14点整，和18点整，每隔5分钟执行一次</span></span><br><span class="line"><span class="comment">     *  【0 15 10 ? * 1-6】 每个月的周一至周六10:15分执行一次</span></span><br><span class="line"><span class="comment">     *  【0 0 2 ? * 6L】每个月的最后一个周六凌晨2点执行一次</span></span><br><span class="line"><span class="comment">     *  【0 0 2 LW * ?】每个月的最后一个工作日凌晨2点执行一次</span></span><br><span class="line"><span class="comment">     *  【0 0 2-4 ? * 1#1】每个月的第一个周一凌晨2点到4点期间，每个整点都执行一次；</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = "0 * * * * MON-SAT")</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = "0,1,2,3,4 * * * * MON-SAT")</span></span><br><span class="line">   <span class="comment">// @Scheduled(cron = "0-4 * * * * MON-SAT")</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron = <span class="string">"0/4 * * * * MON-SAT"</span>)  <span class="comment">//每4秒执行一次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello ... "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>两个注解：@EnableScheduling、@Scheduled</strong></p>
<p><strong>cron表达式：</strong></p>
<table>
<thead>
<tr>
<th><strong>字段</strong></th>
<th><strong>允许值</strong></th>
<th><strong>允许的特殊字符</strong></th>
</tr>
</thead>
<tbody><tr>
<td>秒</td>
<td>0-59</td>
<td>, -   * /</td>
</tr>
<tr>
<td>分</td>
<td>0-59</td>
<td>, -   * /</td>
</tr>
<tr>
<td>小时</td>
<td>0-23</td>
<td>, -   * /</td>
</tr>
<tr>
<td>日期</td>
<td>1-31</td>
<td>, -   * ? / L W C</td>
</tr>
<tr>
<td>月份</td>
<td>1-12</td>
<td>, -   * /</td>
</tr>
<tr>
<td>星期</td>
<td>0-7或SUN-SAT   0,7是SUN</td>
<td>, -   * ? / L C #</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>特殊字符</strong></th>
<th><strong>代表含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td>,</td>
<td>枚举</td>
</tr>
<tr>
<td>-</td>
<td>区间</td>
</tr>
<tr>
<td>*</td>
<td>任意</td>
</tr>
<tr>
<td>/</td>
<td>步长</td>
</tr>
<tr>
<td>?</td>
<td>日/星期冲突匹配</td>
</tr>
<tr>
<td>L</td>
<td>最后</td>
</tr>
<tr>
<td>W</td>
<td>工作日</td>
</tr>
<tr>
<td>C</td>
<td>和calendar联系后计算过的值</td>
</tr>
<tr>
<td>#</td>
<td>星期，4#2，第2个星期四</td>
</tr>
</tbody></table>
<h2 id="三、邮件任务"><a href="#三、邮件任务" class="headerlink" title="三、邮件任务"></a>三、邮件任务</h2><p>•邮件发送需要引入spring-boot-starter-mail</p>
<p>•Spring Boot 自动配置MailSenderAutoConfiguration</p>
<p>•定义MailProperties内容，配置在application.yml中</p>
<p>•自动装配JavaMailSender</p>
<p>•测试邮件发送</p>
<p><strong>1.导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2.配置信息</strong></p>
<p>1)首先在qq邮箱开通相关的服务</p>
<p><img src="//localhost:4000/2019/10/java-note/SpringBootHigh/springBoot-high/.%5CspringBoot-high%5C1569337676687.png" alt="1569337676687"></p>
<p><img src="//localhost:4000/2019/10/java-note/SpringBootHigh/springBoot-high/.%5CspringBoot-high%5C1569337715201.png" alt="1569337715201"></p>
<p><strong>拿到的授权码即为password</strong></p>
<p>application.properties配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## QQ邮箱配置</span></span><br><span class="line"><span class="meta">spring.mail.host</span>=<span class="string">smtp.qq.com</span></span><br><span class="line"><span class="comment">#发送的QQ邮箱</span></span><br><span class="line"><span class="meta">spring.mail.username</span>=<span class="string">1162314270@qq.com</span></span><br><span class="line"><span class="comment"># 如果是qq邮箱,这个地方是授权码 ,不是密码</span></span><br><span class="line"><span class="meta">spring.mail.password</span>=<span class="string">wfqdmurtsvsgiecf</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.starttls.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.starttls.required</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.ssl.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.default-encoding</span>=<span class="string">utf-8</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.ssl.trust</span>=<span class="string">smtp.qq.com</span></span><br><span class="line"><span class="comment">#SSL证书Socket工厂</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class="string">javax.net.ssl.SSLSocketFactory</span></span><br><span class="line"><span class="comment">#使用SMTPS协议465端口</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.socketFactory.port</span>=<span class="string">465</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.auth</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#503错误，我的没有这个错</span></span><br><span class="line"><span class="comment">#spring.mail.properties.mail.smtp.ssl.enable=true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Springboot04TaskApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JavaMailSenderImpl mailSender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleMailMessage message = <span class="keyword">new</span> SimpleMailMessage();</span><br><span class="line">        <span class="comment">//邮件设置</span></span><br><span class="line">        message.setSubject(<span class="string">"通知-今晚开会"</span>);</span><br><span class="line">        message.setText(<span class="string">"今晚7:30开会"</span>);</span><br><span class="line"></span><br><span class="line">        message.setTo(<span class="string">"407820388@qq.com"</span>);</span><br><span class="line">        message.setFrom(<span class="string">"1162314270@qq.com"</span>);</span><br><span class="line"></span><br><span class="line">        mailSender.send(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line">        <span class="comment">//1、创建一个复杂的消息邮件</span></span><br><span class="line">        MimeMessage mimeMessage = mailSender.createMimeMessage();</span><br><span class="line">        MimeMessageHelper helper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//邮件设置</span></span><br><span class="line">        helper.setSubject(<span class="string">"通知-今晚开会"</span>);</span><br><span class="line">        helper.setText(<span class="string">"&lt;b style='color:red'&gt;今天 7:30 开会&lt;/b&gt;"</span>,<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        helper.setTo(<span class="string">"407820388@qq.com"</span>);</span><br><span class="line">        helper.setFrom(<span class="string">"1162314270@qq.com"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//上传文件</span></span><br><span class="line">        helper.addAttachment(<span class="string">"1.jpg"</span>,<span class="keyword">new</span> File(<span class="string">"E:\\pictures\\desktop view.png"</span>));</span><br><span class="line">        helper.addAttachment(<span class="string">"2.jpg"</span>,<span class="keyword">new</span> File(<span class="string">"E:\\pictures\\e.png"</span>));</span><br><span class="line"></span><br><span class="line">        mailSender.send(mimeMessage);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现邮箱激活链接"><a href="#实现邮箱激活链接" class="headerlink" title="实现邮箱激活链接"></a>实现邮箱激活链接</h3><p>学习来自 <a href="https://www.cnblogs.com/smfx1314/p/10332330.html" target="_blank" rel="noopener">https://www.cnblogs.com/smfx1314/p/10332330.html</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态：0代表未激活，1代表激活</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 利用UUID生成一段数字，发动到用户邮箱，当用户点击链接时</span></span><br><span class="line"><span class="comment">     * 在做一个校验如果用户传来的code跟我们发生的code一致，更改状态为“1”来激活用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String  code;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>用户状态status：0代表未激活，1代表激活，注册的时候，默认是0，只有激活邮箱激活码可以更改为1</li>
<li>邮箱激活码code：利用UUID生成一段数字，发动到用户邮箱，当用户点击链接时，在做一个校验，如果用户传来的code跟我们发送的code一致，更改状态为“1”来激活用户</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户注册，注册的时候默认状态为0：未激活，并且调用邮件服务发送激活码到邮箱</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 点击邮箱中的激活码进行激活，根据激活码查询用户，之后再进行修改用户状态为1进行激活</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">checkCode</span><span class="params">(String code)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 激活账户，修改用户状态为“1”进行激活</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUserStatus</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录，根据用户状态为“1”来查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">loginUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UUIDUtils-随机生成激活码"><a href="#UUIDUtils-随机生成激活码" class="headerlink" title="UUIDUtils 随机生成激活码"></a>UUIDUtils 随机生成激活码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UUIDUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">"-"</span>,<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UserController控制类"><a href="#UserController控制类" class="headerlink" title="UserController控制类"></a>UserController控制类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/registerUser"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        user.setStatus(<span class="number">0</span>);</span><br><span class="line">        String code = UUIDUtils.getUUID()+ UUIDUtils.getUUID();</span><br><span class="line">        user.setCode(code);</span><br><span class="line">        userService.register(user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *校验邮箱中的code激活账户</span></span><br><span class="line"><span class="comment">     * 首先根据激活码code查询用户，之后再把状态修改为"1"</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/checkCode"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">checkCode</span><span class="params">(String code)</span></span>&#123;</span><br><span class="line">        User user = userService.checkCode(code);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        <span class="comment">//如果用户不等于null，把用户状态修改status=1</span></span><br><span class="line">       <span class="keyword">if</span> (user !=<span class="keyword">null</span>)&#123;</span><br><span class="line">           user.setStatus(<span class="number">1</span>);</span><br><span class="line">           <span class="comment">//把code验证码清空，已经不需要了</span></span><br><span class="line">           user.setCode(<span class="string">""</span>);</span><br><span class="line">           System.out.println(user);</span><br><span class="line">           userService.updateUserStatus(user);</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转到登录页面</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> login</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/loginPage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/loginUser"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(User user, Model model)</span></span>&#123;</span><br><span class="line">        User u = userService.loginUser(user);</span><br><span class="line">        <span class="keyword">if</span> (u !=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"welcome"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">//根据激活码code查询用户</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user where code = #&#123;code&#125;"</span>)</span><br><span class="line">    <span class="function">User <span class="title">checkCode</span><span class="params">(String code)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    激活账户，修改用户状态</span></span><br><span class="line">    <span class="meta">@Update</span>(<span class="string">"update user set status=1,code=null WHERE user_id = #&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUserStatus</span><span class="params">(Integer userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    根据用户名，返回激活状态的用户</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"SELECT * FROM `user` WHERE username = #&#123;username&#125; and status = 1  LIMIT 1"</span>)</span><br><span class="line">    <span class="function">User <span class="title">getActiveUserByName</span><span class="params">(String username)</span></span>;</span><br></pre></td></tr></table></figure>

<p>public class EmailSender {</p>
<pre><code>@Value(&quot;${spring.mail.username}&quot;)
private String from;
@Autowired
EmailCache emailCache;
@Autowired
JavaMailSenderImpl mailSender;

/**
 * @Description: 发送注册邮件和验证码,send email is take long time so add async
 * @Param: [email]
 * @return: java.lang.String null:发送邮件失败
 * @Author: lmz
 * @Date: 2019/10/20
 */
@Async
public String sendResetPasswordEmail(String email) {
    String checkCode = String.valueOf(new Random().nextInt(899999) + 100000);
    try{
        //发送邮件
        sendEmailMessage(email, &quot;YOJ重置验证码&quot;,
                &quot;您的重置验证码为：&quot; + checkCode);
    }catch (Exception e){
        e.printStackTrace();
        return null;
    }
    //设置缓存
    emailCache.setEmailCheckCode(email,checkCode);
    return checkCode;
}

/**
 * @Description: 发送注册邮件和验证码
 * @Param: [email]
 * @return: java.lang.String null:发送邮件失败
 * @Author: lmz
 * @Date: 2019/10/20
 */
@Async
public String sendRegisterEmail(String email) {
    //删除缓存</code></pre><p>EmailSender</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailSender</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.mail.username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String from;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EmailCache emailCache;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JavaMailSenderImpl mailSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送HTML邮件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to 收件者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject 邮件主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 文本内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendHtmlMail</span><span class="params">(String to,String subject,String content)</span> </span>&#123;</span><br><span class="line">        MimeMessage message = mailSender.createMimeMessage();</span><br><span class="line">        MimeMessageHelper helper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            helper = <span class="keyword">new</span> MimeMessageHelper(message, <span class="keyword">true</span>);</span><br><span class="line">            helper.setFrom(from);</span><br><span class="line">            helper.setTo(subject);</span><br><span class="line">            helper.setTo(to);</span><br><span class="line">            helper.setText(content, <span class="keyword">true</span>);</span><br><span class="line">            mailSender.send(message);</span><br><span class="line">            <span class="comment">//日志信息</span></span><br><span class="line">            log.info(<span class="string">"邮件已经发送。"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">            log.error(<span class="string">"发送邮件时发生异常！"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>}</p>
<h1 id="五-Spring-Boot与安全"><a href="#五-Spring-Boot与安全" class="headerlink" title="五.Spring Boot与安全"></a>五.Spring Boot与安全</h1><h2 id="一、安全"><a href="#一、安全" class="headerlink" title="一、安全"></a>一、安全</h2><p>Spring Security是针对Spring项目的安全框架，也是Spring Boot底层安全模块默认的技术选型。他可以实现强大的web安全控制。对于安全控制，我们仅需引入spring-boot-starter-security模块，进行少量的配置，即可实现强大的安全管理。</p>
<p> 几个类：</p>
<p>WebSecurityConfigurerAdapter：自定义Security策略</p>
<p>AuthenticationManagerBuilder：自定义认证策略</p>
<p>@EnableWebSecurity：开启WebSecurity模式</p>
<h3 id="“认证”和“授权”"><a href="#“认证”和“授权”" class="headerlink" title="“认证”和“授权”"></a>“认证”和“授权”</h3><p>•应用程序的两个主要区域是“认证”和“授权”（或者访问控制）。这两个主要区域是Spring Security 的两个目标。</p>
<p>•<strong>“认证”（Authentication）</strong>，是建立一个他声明的主体的过程（一个“主体”一般是指用户，设备或一些可以在你的应用程序中执行动作的其他系统）。</p>
<p>•“<strong>授权”（Authorization）</strong>指确定一个主体是否允许在你的应用程序执行一个动作的过程。为了抵达需要授权的店，主体的身份已经有认证过程建立。</p>
<p>•这个概念是通用的而不只在Spring Security中。</p>
<h2 id="二、Web-amp-安全"><a href="#二、Web-amp-安全" class="headerlink" title="二、Web&amp;安全"></a>二、Web&amp;安全</h2><p>1.登陆/注销</p>
<p>–HttpSecurity配置登陆、注销功能</p>
<p>2.Thymeleaf提供的SpringSecurity标签支持</p>
<p>–需要引入thymeleaf-extras-springsecurity5（版本要一致）</p>
<p>–sec:authentication=“name”获得当前用户的用户名</p>
<p>–sec:authorize=“hasRole(‘ADMIN’)”当前用户必须拥有ADMIN权限时才会显示标签内容</p>
<p>3.remember me</p>
<p>–表单添加remember-me的checkbox</p>
<p>–配置启用remember-me功能</p>
<p>4.CSRF（Cross-site request forgery）跨站请求伪造</p>
<p>HttpSecurity启用功能，会为表单添加csrfCSRF</p>
<h2 id="使用SpringSecurity"><a href="#使用SpringSecurity" class="headerlink" title="使用SpringSecurity"></a>使用SpringSecurity</h2><p><a href="https://spring.io/projects/spring-security" target="_blank" rel="noopener">官方文档</a></p>
<h3 id="1、引入SpringSecurity；"><a href="#1、引入SpringSecurity；" class="headerlink" title="1、引入SpringSecurity；"></a>1、引入SpringSecurity；</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2、编写SpringSecurity的配置类；"><a href="#2、编写SpringSecurity的配置类；" class="headerlink" title="2、编写SpringSecurity的配置类；"></a>2、编写SpringSecurity的配置类；</h3><p><strong>使用之间需要PasswordEncoder的bean存在</strong></p>
<p>使用springboot，权限管理使用spring security，使用内存用户验证，但无响应报错：<br>java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id “null”<br>解决方法：<br>这是因为Spring boot 2.0.3引用的security 依赖是 spring security 5.X版本，此版本需要提供一个PasswordEncorder的实例，否则后台汇报错误：<br>java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id “null”<br>并且页面毫无响应。<br>因此，需要创建PasswordEncorder的实现类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> springboot05security.nicolas.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> charSequence.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence charSequence, String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.equals(charSequence.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>自定义securityConfig需要继承WebSecurityConfigurerAdapter</strong></p>
<p>3、控制请求的访问权限：<br>configure(HttpSecurity http) {<br>http.authorizeRequests().antMatchers(“/“).permitAll()<br>.antMatchers(“/level1/**”).hasRole(“VIP1”)<br>}</p>
<h3 id="4、定义认证规则："><a href="#4、定义认证规则：" class="headerlink" title="4、定义认证规则："></a>4、定义认证规则：</h3><p>configure(AuthenticationManagerBuilder auth){<br>auth.inMemoryAuthentication()<br>.withUser(“zhangsan”).password(“123456”).roles(“VIP1”,”VIP2”)<br>}</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义认证规则</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">     <span class="comment">//super.configure(auth);</span></span><br><span class="line">     auth.inMemoryAuthentication()</span><br><span class="line">             .withUser(<span class="string">"zhangsan"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"VIP1"</span>, <span class="string">"VIP2"</span>)</span><br><span class="line">             .and()</span><br><span class="line">             .withUser(<span class="string">"lisi"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"VIP2"</span>, <span class="string">"VIP3"</span>)</span><br><span class="line">             .and()</span><br><span class="line">             .withUser(<span class="string">"wangwu"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"VIP1"</span>, <span class="string">"VIP3"</span>);</span><br><span class="line">             <span class="comment">/**有以下几种形式，使用第3种*/</span></span><br><span class="line">     <span class="comment">//inMemoryAuthentication 从内存中获取</span></span><br><span class="line">     <span class="comment">//auth.inMemoryAuthentication().passwordEncoder(new BCryptPasswordEncoder()).withUser("user1").password(new BCryptPasswordEncoder().encode("123123")).roles("USER");</span></span><br><span class="line"> </span><br><span class="line">     <span class="comment">//jdbcAuthentication从数据库中获取，但是默认是以security提供的表结构</span></span><br><span class="line">     <span class="comment">//usersByUsernameQuery 指定查询用户SQL</span></span><br><span class="line">     <span class="comment">//authoritiesByUsernameQuery 指定查询权限SQL</span></span><br><span class="line">     <span class="comment">//auth.jdbcAuthentication().dataSource(dataSource).usersByUsernameQuery(query).authoritiesByUsernameQuery(query);</span></span><br><span class="line"> </span><br><span class="line">     <span class="comment">//注入userDetailsService，需要实现userDetailsService接口</span></span><br><span class="line">     auth.userDetailsService(userDetailsService).passwordEncoder(<span class="keyword">new</span> BCryptPasswordEncoder());</span><br></pre></td></tr></table></figure>

<p>==<strong>使用注入userDetailsService，需要实现userDetailsService接口</strong>==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PrivilegeService privilegeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        User user = userMapper.getUserByName(username);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"没有该用户"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserDetailsImpl(user, privilegeService.queryByUserId(user.getUserId()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsImpl</span> <span class="keyword">implements</span> <span class="title">UserDetails</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">//包含着用户对应的所有Privilege，在使用时调用者给对象注入Privileges</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Privilege&gt; privilege;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> com.yoj.web.service.PrivilegeService PrivilegeService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrivilege</span><span class="params">(List&lt;Privilege&gt; privilege)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.privilege = privilege;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无参构造</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用User构造</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsImpl</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = user.getUserName();</span><br><span class="line">        <span class="keyword">this</span>.password = user.getPassword();</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用User和List&lt;Privilege&gt;构造</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetailsImpl</span><span class="params">(User user,List&lt;Privilege&gt; Privileges)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">        <span class="keyword">this</span>.username = user.getUserName();</span><br><span class="line">        <span class="keyword">this</span>.password = user.getPassword();</span><br><span class="line">        <span class="keyword">this</span>.privilege = Privileges;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Privilege&gt; <span class="title">getPrivilege</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> privilege;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//返回用户所有角色的封装，一个Privilege对应一个GrantedAuthority</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(Privilege Privilege : privilege) &#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(Privilege.getRight()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//判断账号是否已经过期，默认没有过期</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//判断账号是否被锁定，默认没有锁定</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//判断信用凭证是否过期，默认没有过期</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//判断账号是否可用，默认可用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、开启自动配置的登陆功能："><a href="#5、开启自动配置的登陆功能：" class="headerlink" title="5、开启自动配置的登陆功能："></a>5、开启自动配置的登陆功能：</h3><p>1、/login来到登陆页<br>2、重定向到/login?error表示登陆失败<br>3、更多详细规定<br>4、默认post形式的 /login代表处理登陆<br>5、一但定制loginPage；那么 loginPage的post请求就是登陆</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> 		http.formLogin().usernameParameter(<span class="string">"user"</span>).passwordParameter(<span class="string">"pwd"</span>)</span><br><span class="line">                .loginPage(<span class="string">"/userlogin"</span>);</span><br></pre></td></tr></table></figure>

<p>configure(HttpSecurity http){<br>http.formLogin();<br>}</p>
<h3 id="6、注销：http-logout"><a href="#6、注销：http-logout" class="headerlink" title="6、注销：http.logout();"></a>6、注销：http.logout();</h3><p><strong>注意logout时需要表单中的按钮</strong></p>
<p>1、访问 /logout 表示用户注销，清空session<br>2、注销成功会返回 /login?logout 页面；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.logout().logoutSuccessUrl(<span class="string">"/"</span>);<span class="comment">//注销成功以后来到首页</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/logout&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注销"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>7、记住我：Remeberme()</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/userlogin&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"user"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"pwd"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"remember"</span>&gt;</span> 记住我<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登陆"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>8获取UserDetails</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserDetailsImpl userDetails = (UserDetailsImpl) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">        System.out.println(userDetails);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//super.configure(http);</span></span><br><span class="line">        <span class="comment">//定制请求的授权规则</span></span><br><span class="line">        http.authorizeRequests().antMatchers(<span class="string">"/"</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/level1/**"</span>).hasRole(<span class="string">"VIP1"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/level2/**"</span>).hasRole(<span class="string">"VIP2"</span>)</span><br><span class="line">                .antMatchers(<span class="string">"/level3/**"</span>).hasRole(<span class="string">"VIP3"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启自动配置的登陆功能，效果，如果没有登陆，没有权限就会来到登陆页面</span></span><br><span class="line">        <span class="comment">//http.formLogin();</span></span><br><span class="line">        <span class="comment">//1、/login来到登陆页</span></span><br><span class="line">        <span class="comment">//2、重定向到/login?error表示登陆失败</span></span><br><span class="line">        <span class="comment">//3、更多详细规定</span></span><br><span class="line">        <span class="comment">//4、默认post形式的 /login代表处理登陆</span></span><br><span class="line">        <span class="comment">//5、一但定制loginPage；那么 loginPage的post请求就是登陆</span></span><br><span class="line">        http.formLogin().usernameParameter(<span class="string">"user"</span>).passwordParameter(<span class="string">"pwd"</span>)</span><br><span class="line">                .loginPage(<span class="string">"/userlogin"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启自动配置的注销功能。</span></span><br><span class="line"><span class="comment">//        http.logout();</span></span><br><span class="line">        <span class="comment">//1、访问 /logout 表示用户注销，清空session</span></span><br><span class="line">        <span class="comment">//2、注销成功会返回 /login?logout 页面；</span></span><br><span class="line">        http.logout().logoutSuccessUrl(<span class="string">"/"</span>);<span class="comment">//注销成功以后来到首页</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启记住我功能</span></span><br><span class="line"><span class="comment">//        http.rememberMe();</span></span><br><span class="line">        <span class="comment">//登陆成功以后，将cookie发给浏览器保存，以后访问页面带上这个cookie，只要通过检查就可以免登录</span></span><br><span class="line">        <span class="comment">//点击注销会删除cookie</span></span><br><span class="line">        http.rememberMe().rememberMeParameter(<span class="string">"remember"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义认证规则</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//super.configure(auth);</span></span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(<span class="string">"zhangsan"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"VIP1"</span>, <span class="string">"VIP2"</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(<span class="string">"lisi"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"VIP2"</span>, <span class="string">"VIP3"</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(<span class="string">"wangwu"</span>).password(<span class="string">"123456"</span>).roles(<span class="string">"VIP1"</span>, <span class="string">"VIP3"</span>);</span><br><span class="line">                <span class="comment">/**有以下几种形式，使用第3种*/</span></span><br><span class="line">        <span class="comment">//inMemoryAuthentication 从内存中获取</span></span><br><span class="line">        <span class="comment">//auth.inMemoryAuthentication().passwordEncoder(new BCryptPasswordEncoder()).withUser("user1").password(new BCryptPasswordEncoder().encode("123123")).roles("USER");</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//jdbcAuthentication从数据库中获取，但是默认是以security提供的表结构</span></span><br><span class="line">        <span class="comment">//usersByUsernameQuery 指定查询用户SQL</span></span><br><span class="line">        <span class="comment">//authoritiesByUsernameQuery 指定查询权限SQL</span></span><br><span class="line">        <span class="comment">//auth.jdbcAuthentication().dataSource(dataSource).usersByUsernameQuery(query).authoritiesByUsernameQuery(query);</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//注入userDetailsService，需要实现userDetailsService接口</span></span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(<span class="keyword">new</span> BCryptPasswordEncoder());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>定义认证用户信息获取来源，密码校验规则等</strong></p>
<h2 id="Thymeleaf-Extras-Springsecurity"><a href="#Thymeleaf-Extras-Springsecurity" class="headerlink" title="Thymeleaf Extras Springsecurity"></a>Thymeleaf Extras Springsecurity</h2><p>注意：thymeleaf和springsecurity版本一致，Thymeleaf Extras <strong>Springsecurity5</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.thymeleaf.extras/thymeleaf-extras-springsecurity5 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">div sec:authorize="!isAuthenticated()"&gt;</span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span>游客您好，如果想查看武林秘籍 <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/userlogin&#125;"</span>&gt;</span>请登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">"isAuthenticated()"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>，您好,您的角色有：</span><br><span class="line">		<span class="tag">&lt;<span class="name">span</span> <span class="attr">sec:authentication</span>=<span class="string">"principal.authorities"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/logout&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注销"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">sec:authorize</span>=<span class="string">"hasRole('VIP1')"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h3</span>&gt;</span>普通武功秘籍<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/level1/1&#125;"</span>&gt;</span>罗汉拳<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/level1/2&#125;"</span>&gt;</span>武当长拳<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/level1/3&#125;"</span>&gt;</span>全真剑法<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="在Spring-Security中使用AJAX向后台传送数据"><a href="#在Spring-Security中使用AJAX向后台传送数据" class="headerlink" title="在Spring Security中使用AJAX向后台传送数据"></a>在Spring Security中使用AJAX向后台传送数据</h2><p>本文链接：<a href="https://blog.csdn.net/bnrmaster/article/details/52939212" target="_blank" rel="noopener">https://blog.csdn.net/bnrmaster/article/details/52939212</a></p>
<p>环境：spring 4.2.3</p>
<p>  spring security 4.1.3</p>
<p>表现：</p>
<p>2016-10-26 22:44:02 [http-apr-9080-exec-10] DEBUG org.springframework.security.web.csrf.CsrfFilter - Invalid CSRF token found for XXX<br>2016-10-26 22:44:02 [http-apr-9080-exec-10] DEBUG org.springframework.security.web.header.writers.HstsHeaderWriter - Not injecting HSTS header since it did not match the requestMatcher org.springframework.security.web.header.writers.HstsHeaderWriter$SecureRequestMatcher@c3339ef<br>2016-10-26 22:44:02 [http-apr-9080-exec-10] DEBUG org.springframework.security.web.context.SecurityContextPersistenceFilter - SecurityContextHolder now cleared, as request processing completed</p>
<p>前台使用AJAX向后台传输数据时候控制台报出上述错误，再未集成Spring Security时不会出现此现象</p>
<p>解决方法：</p>
<p>如果前端使用的JSP</p>
<p>可以在前端页面的<head><meta name="generator" content="Hexo 3.9.0">标签中增加两个<meta>标签<link rel="alternate" href="/atom.xml" title="nicolas" type="application/atom+xml">
</head></p>
<p>如下</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"_csrf"</span> <span class="attr">content</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;_csrf.token&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="comment">&lt;!-- default header name is X-CSRF-TOKEN --&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"_csrf_header"</span> <span class="attr">content</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;_csrf.headerName&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="comment">&lt;!-- ... --&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>如果前端使用的是Thymeleaf分两种情况</p>
<p>1.前端无form表单,也要再头部增加两个meta标签，形式为</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"_csrf"</span> <span class="attr">th:content</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;_csrf.token&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">content</span>=<span class="string">""</span>/&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="comment">&lt;!-- default header name is X-CSRF-TOKEN --&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"_csrf_header"</span> <span class="attr">th:content</span>=<span class="string">"$</span></span></span><span class="template-variable">&#123;_csrf.headerName&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">content</span>=<span class="string">""</span>/&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="comment">&lt;!-- ... --&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>2.前端有form表单</p>
<p>  Spring Security为Thymeleaf中的表单中自动添加一个<input type="hidden" name="_csrf" value="xxxxxxxxxx">  (xxxx为crrf.token)</p>
<p>添加完meta之后不妨运行下，在页面代码中搜索_csrf，可以看看附近代码的样子，应该就会明白了</p>
<p>这样在使用AJAX时，需要增加一个头部</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> token = $(<span class="string">"meta[name='_csrf']"</span>).attr(<span class="string">"content"</span>);</span><br><span class="line"><span class="keyword">var</span> header = $(<span class="string">"meta[name='_csrf_header']"</span>).attr(<span class="string">"content"</span>);</span><br><span class="line">	 $.ajax(&#123;  </span><br><span class="line">                   type: <span class="string">"POST"</span>,  </span><br><span class="line">                   url: <span class="string">"myposturl"</span>,  </span><br><span class="line">                   data: entID, </span><br><span class="line">                   contentType:<span class="string">"application/json; charset=utf-8"</span>,</span><br><span class="line">                   headers : &#123;<span class="attr">header</span>:token&#125;,</span><br><span class="line">                   async:<span class="literal">false</span>,</span><br><span class="line">                   success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;  </span><br><span class="line">	       		<span class="comment">//do something</span></span><br><span class="line">                   &#125;,</span><br><span class="line">                   error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                	<span class="comment">//deal width error    </span></span><br><span class="line">                   &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure>

<p>实际上，这里的header使用为值”X-CSRF-TOKEN” 这样就可以成功向后台请求了</p>
<p><strong>spring security reference</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> csrfHeader = $(<span class="string">"meta[name='_csrf_header']"</span>).attr(<span class="string">"content"</span>);</span><br><span class="line"><span class="keyword">var</span> csrfToken = $(<span class="string">"meta[name='_csrf']"</span>).attr(<span class="string">"content"</span>);</span><br><span class="line"><span class="keyword">var</span> headers = &#123;&#125;;</span><br><span class="line">headers[csrfHeader] = csrfToken;</span><br><span class="line">console.log(problem);</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    url: <span class="string">"/p/add"</span>,</span><br><span class="line">    type: <span class="string">"POST"</span>,</span><br><span class="line">    headers : headers,</span><br><span class="line">    data: problem,</span><br><span class="line">    success(res)&#123;</span><br><span class="line">        <span class="comment">// $("id").add(res);</span></span><br><span class="line">        console.log(res);</span><br><span class="line">    &#125;,</span><br><span class="line">    error(res)&#123;</span><br><span class="line">        console.log(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>CSRF Protected JavaScript Page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"This is the description for this page"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sec:csrfMetaTags</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">language</span>=<span class="string">"javascript"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> csrfParameter = $(<span class="string">"meta[name='_csrf_parameter']"</span>).attr(<span class="string">"content"</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> csrfHeader = $(<span class="string">"meta[name='_csrf_header']"</span>).attr(<span class="string">"content"</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> csrfToken = $(<span class="string">"meta[name='_csrf']"</span>).attr(<span class="string">"content"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// using XMLHttpRequest directly to send an x-www-form-urlencoded request</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> ajax = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">            ajax.open(<span class="string">"POST"</span>, <span class="string">"https://www.example.org/do/something"</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="actionscript">            ajax.setRequestHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded data"</span>);</span></span><br><span class="line"><span class="actionscript">            ajax.send(csrfParameter + <span class="string">"="</span> + csrfToken + <span class="string">"&amp;name=John&amp;..."</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// using XMLHttpRequest directly to send a non-x-www-form-urlencoded request</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> ajax = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">            ajax.open(<span class="string">"POST"</span>, <span class="string">"https://www.example.org/do/something"</span>, <span class="literal">true</span>);</span></span><br><span class="line">            ajax.setRequestHeader(csrfHeader, csrfToken);</span><br><span class="line"><span class="actionscript">            ajax.send(<span class="string">"..."</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// using JQuery to send an x-www-form-urlencoded request</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> data = &#123;&#125;;</span></span><br><span class="line">            data[csrfParameter] = csrfToken;</span><br><span class="line"><span class="actionscript">            data[<span class="string">"name"</span>] = <span class="string">"John"</span>;</span></span><br><span class="line">            ...</span><br><span class="line"><span class="javascript">            $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">"https://www.example.org/do/something"</span>,</span></span><br><span class="line"><span class="actionscript">                type: <span class="string">"POST"</span>,</span></span><br><span class="line">                data: data,</span><br><span class="line">                ...</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="comment">// using JQuery to send a non-x-www-form-urlencoded request</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> headers = &#123;&#125;;</span></span><br><span class="line">            headers[csrfHeader] = csrfToken;</span><br><span class="line"><span class="javascript">            $.ajax(&#123;</span></span><br><span class="line"><span class="actionscript">                url: <span class="string">"https://www.example.org/do/something"</span>,</span></span><br><span class="line"><span class="actionscript">                type: <span class="string">"POST"</span>,</span></span><br><span class="line">                headers: headers,</span><br><span class="line">                ...</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span></span><br><span class="line">        ...</span><br><span class="line"><span class="handlebars"><span class="xml">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure>

<p>六、Spring Boot与分布式</p>
<p>七、Spring Boot与监控管理</p>
<p>八、Spring Boot与部署</p>
<h1 id="七-开发热部署"><a href="#七-开发热部署" class="headerlink" title="七.开发热部署"></a>七.开发热部署</h1><h2 id="一、热部署"><a href="#一、热部署" class="headerlink" title="一、热部署"></a>一、热部署</h2><p>在开发中我们修改一个Java文件后想看到效果不得不重启应用，这导致大量时间花费，我们希望不重启应用的情况下，程序可以<strong>自动部署（热部署）</strong>。有以下四种情况，如何能实现热部署。</p>
<p>•1、模板引擎</p>
<p>–在Spring Boot中开发情况下禁用模板引擎的cache</p>
<p>–页面模板改变ctrl+F9可以重新编译当前页面并生效</p>
<p>2、Spring Loaded</p>
<p>Spring官方提供的热部署程序，实现修改类文件的热部署</p>
<p>–下载Spring Loaded（项目地址<a href="https://github.com/spring-projects/spring-loaded）" target="_blank" rel="noopener">https://github.com/spring-projects/spring-loaded）</a></p>
<p>–添加运行时参数；</p>
<p>-javaagent:C:/springloaded-1.2.5.RELEASE.jar –noverify</p>
<p>3、JRebel</p>
<p>–收费的一个热部署软件</p>
<p>–安装插件使用即可</p>
<h2 id="4、Spring-Boot-Devtools（推荐）"><a href="#4、Spring-Boot-Devtools（推荐）" class="headerlink" title="4、Spring Boot Devtools（推荐）"></a>4、Spring Boot Devtools（推荐）</h2><p>–引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>   </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>–<strong>IDEA使用ctrl+F9</strong></p>
<p>–或做一些小调整</p>
<p>  <em>Intellij</em> <em>IEDA<strong>和</strong>Eclipse<strong>不同，</strong>Eclipse<strong>设置了自动编译之后，修改类它会自动编译</strong>，而<strong>IDEA</strong>在非<strong>RUN</strong>或<strong>DEBUG</strong>情况下才会自动编译（前提是你已经设置了<strong>Auto-Compile</strong>）。</em></p>
<p>•设置自动编译（settings-compiler-make project automatically）</p>
<p>•ctrl+shift+alt+/（maintenance）</p>
<p>•勾选compiler.automake.allow.when.app.running</p>

    </div>

    
    
    
    
    <div>
     
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

     
    </div>
    
        
      
        <div id="reward-container">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">

  </div>
</div>

      
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>nicolas lee</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://codeofli.github.io/2019/10/java-note/SpringBootHigh/springBoot-high/" title="springBoot高级">https://codeofli.github.io/2019/10/java-note/SpringBootHigh/springBoot-high/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>
</div>

      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/java/" rel="tag"># java</a>
            
              <a href="/tags/spring/" rel="tag"># spring</a>
            
              <a href="/tags/springBoot/" rel="tag"># springBoot</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/09/hexo/hexo/" rel="next" title="hexo">
                  <i class="fa fa-chevron-left"></i> hexo
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/10/js-note/jquery/jquery/" rel="prev" title="jquery">
                  jquery <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-Spring-Boot与缓存"><span class="nav-number">1.</span> <span class="nav-text">一.Spring Boot与缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、JSR107"><span class="nav-number">1.1.</span> <span class="nav-text">1、JSR107</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、快速体验缓存"><span class="nav-number">1.2.</span> <span class="nav-text">2、快速体验缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CacheConfig注解"><span class="nav-number">1.2.1.</span> <span class="nav-text">@CacheConfig注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤："><span class="nav-number">1.2.2.</span> <span class="nav-text">步骤：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cacheable注解"><span class="nav-number">1.2.3.</span> <span class="nav-text">@Cacheable注解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#原理："><span class="nav-number">1.2.3.1.</span> <span class="nav-text">原理：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行流程：-ConcurrentMapCacheManager-class"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">运行流程：(ConcurrentMapCacheManager.class)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#几个属性："><span class="nav-number">1.2.4.</span> <span class="nav-text">几个属性：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CachePut注解"><span class="nav-number">1.2.5.</span> <span class="nav-text">@CachePut注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CacheEvict注解"><span class="nav-number">1.2.6.</span> <span class="nav-text">@CacheEvict注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Caching注解"><span class="nav-number">1.2.7.</span> <span class="nav-text">@Caching注解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-整合redis作为缓存"><span class="nav-number">1.3.</span> <span class="nav-text">3.整合redis作为缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、安装redis：使用docker；"><span class="nav-number">1.3.1.</span> <span class="nav-text">1、安装redis：使用docker；</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、引入redis的starter"><span class="nav-number">1.3.2.</span> <span class="nav-text">2、引入redis的starter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、配置redis"><span class="nav-number">1.3.3.</span> <span class="nav-text">3、配置redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、测试缓存"><span class="nav-number">1.3.4.</span> <span class="nav-text">4、测试缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-使用Json格式序列化对象"><span class="nav-number">1.3.5.</span> <span class="nav-text">5.使用Json格式序列化对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0配置redis的CacheManager"><span class="nav-number">1.4.</span> <span class="nav-text">2.0配置redis的CacheManager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-注意"><span class="nav-number">1.5.</span> <span class="nav-text">4.注意</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-CachePut-获取就是返回的值"><span class="nav-number">1.6.</span> <span class="nav-text">1.@CachePut 获取就是返回的值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#my-redis"><span class="nav-number">1.7.</span> <span class="nav-text">my_redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设置缓存时间"><span class="nav-number">1.7.1.</span> <span class="nav-text">设置缓存时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除缓存byKey"><span class="nav-number">1.7.2.</span> <span class="nav-text">删除缓存byKey</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查时间"><span class="nav-number">1.7.3.</span> <span class="nav-text">检查时间</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">1.8.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redis一段时间之后不连接就连不上"><span class="nav-number">1.8.1.</span> <span class="nav-text">redis一段时间之后不连接就连不上</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-Spring-Boot与消息"><span class="nav-number">2.</span> <span class="nav-text">二.Spring Boot与消息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、概述"><span class="nav-number">2.1.</span> <span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、RabbitMQ简介"><span class="nav-number">2.2.</span> <span class="nav-text">二、RabbitMQ简介</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-Spring-Boot与任务"><span class="nav-number">3.</span> <span class="nav-text">四.Spring Boot与任务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#异步任务、定时任务、邮件任务"><span class="nav-number">3.1.</span> <span class="nav-text">异步任务、定时任务、邮件任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一、异步任务"><span class="nav-number">3.2.</span> <span class="nav-text">一、异步任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、定时任务"><span class="nav-number">3.3.</span> <span class="nav-text">二、定时任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、邮件任务"><span class="nav-number">3.4.</span> <span class="nav-text">三、邮件任务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实现邮箱激活链接"><span class="nav-number">3.4.1.</span> <span class="nav-text">实现邮箱激活链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UUIDUtils-随机生成激活码"><span class="nav-number">3.4.2.</span> <span class="nav-text">UUIDUtils 随机生成激活码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UserController控制类"><span class="nav-number">3.4.3.</span> <span class="nav-text">UserController控制类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五-Spring-Boot与安全"><span class="nav-number">4.</span> <span class="nav-text">五.Spring Boot与安全</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、安全"><span class="nav-number">4.1.</span> <span class="nav-text">一、安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#“认证”和“授权”"><span class="nav-number">4.1.1.</span> <span class="nav-text">“认证”和“授权”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Web-amp-安全"><span class="nav-number">4.2.</span> <span class="nav-text">二、Web&amp;安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用SpringSecurity"><span class="nav-number">4.3.</span> <span class="nav-text">使用SpringSecurity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、引入SpringSecurity；"><span class="nav-number">4.3.1.</span> <span class="nav-text">1、引入SpringSecurity；</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、编写SpringSecurity的配置类；"><span class="nav-number">4.3.2.</span> <span class="nav-text">2、编写SpringSecurity的配置类；</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、定义认证规则："><span class="nav-number">4.3.3.</span> <span class="nav-text">4、定义认证规则：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5、开启自动配置的登陆功能："><span class="nav-number">4.3.4.</span> <span class="nav-text">5、开启自动配置的登陆功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6、注销：http-logout"><span class="nav-number">4.3.5.</span> <span class="nav-text">6、注销：http.logout();</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thymeleaf-Extras-Springsecurity"><span class="nav-number">4.4.</span> <span class="nav-text">Thymeleaf Extras Springsecurity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在Spring-Security中使用AJAX向后台传送数据"><span class="nav-number">4.5.</span> <span class="nav-text">在Spring Security中使用AJAX向后台传送数据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七-开发热部署"><span class="nav-number">5.</span> <span class="nav-text">七.开发热部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、热部署"><span class="nav-number">5.1.</span> <span class="nav-text">一、热部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、Spring-Boot-Devtools（推荐）"><span class="nav-number">5.2.</span> <span class="nav-text">4、Spring Boot Devtools（推荐）</span></a></li></ol></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/assets/img/avatar.jpg"
      alt="nicolas lee">
  <p class="site-author-name" itemprop="name">nicolas lee</p>
  <div class="site-description" itemprop="description">Yesterday you said tomorow.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/codeOflI" title="GitHub &rarr; https://github.com/codeOflI" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://blog.csdn.net/qq_42835910" title="CSDN &rarr; https://blog.csdn.net/qq_42835910" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a>
      </span>
    
  </div>
  <div class="cc-license motion-element" itemprop="license">
    
  
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nicolas lee</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数"></span>
</div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/pisces.js?v=7.4.1"></script>

<script src="/js/next-boot.js?v=7.4.1"></script>



  





















  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>